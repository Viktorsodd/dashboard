<script type="text/html" settings>
	<div class="padding">
		<div class="m" data-jc="dropdown" data-jc-path="id" data-required="true" data-source="common.instances" data-source-condition="n => n.component === 'dashboardanalytics'" data-empty="">@(Flow instance)</div>
		<div data-jc="multioptions" data-jc-path="?">
			<script type="text/plain">
				option('background', 'Background Color', '#8CC152', 'Color');
				option('type', 'Type', 'days', ['hours', 'days', 'months', 'years']);
				option('high', 'High value', null, 'Number');
				option('low', 'Low value', null, 'Number');
				option('showArea', 'Show area', true);
				option('showPoint', 'Show point', true);
				option('showLine', 'Show line', true);
				option('smoothCurves', 'No smooth curves', true);
				option('XshowLabel', 'Axis X: Show Label', true);
				option('XshowGrid', 'Axis X: Show Grid', true);
				option('YshowLabel', 'Axis Y: Show Label', true);
				option('YshowGrid', 'Axis Y: Show Grid', false);
				option('onlyInteger', 'Whole numbers', true);
				option('dateFormat', 'Date format', 'dd.MM', ['HH:mm', 'dd', 'ddd', 'dd.MM', 'dd.MM.yyyy', 'MMMM', 'MM.yyyy']);
				option('formatter', 'Format', '{0}');
				option('decimals', 'Decimals', 1);
			</script>
		</div>
	</div>
</script>

<style type="text/css">
	.dashboardlinechart .ct-label { font-size: 1rem; }
	.dashboardlinechart .ct-label.ct-horizontal.ct-end { transform: translate(-50%,0); display: block; text-align: center; }
</style>

<script>
exports.name = 'linechart';
exports.title = 'Line chart';
exports.icon = 'fa-line-chart';
exports.author = 'Peter Å irka';
exports.group = 'Analytics';
exports.options = { id: null, background: '#434A54', type: 'days', high: null, low: null, showArea: true, showPoint: true, showLine: true, smoothCurves: true, XshowLabel: true, XshowGrid: true, YshowLabel: true, YshowGrid: false, onlyInteger: true, dateFormat: 'dd.MM', formatter: '{0}', decimals: 1 };
exports.version = '1.0.0';

exports.install = function(instance) {

	var chart, backup;

	instance.shade = function(color, percent) {
		var R = parseInt(color.substring(1,3),16);
		var G = parseInt(color.substring(3,5),16);
		var B = parseInt(color.substring(5,7),16);

		R = parseInt(R * (100 + percent) / 100);
		G = parseInt(G * (100 + percent) / 100);
		B = parseInt(B * (100 + percent) / 100);

		R = (R<255)?R:255;
		G = (G<255)?G:255;
		B = (B<255)?B:255;

		var RR = ((R.toString(16).length==1)?'0'+R.toString(16):R.toString(16));
		var GG = ((G.toString(16).length==1)?'0'+G.toString(16):G.toString(16));
		var BB = ((B.toString(16).length==1)?'0'+B.toString(16):B.toString(16));

		return '#' + RR + GG + BB;
	};

	instance.on('data', function(response) {

		if (RELEASE && (!instance.options.id || response.id !== instance.options.id || response.type !== 'stats'))
			return;

		backup = response;

		var size = instance.size;
		var data = {};
		var value = response.body;

		data.labels = [];
		data.series = [[]];

		var c = (size.width / 40) >> 0;
		var l = value[instance.options.type].length;
		if (c < l)
			value[instance.options.type] = value[instance.options.type].ticks(c);

		value[instance.options.type].forEach(function(item) {
			data.labels.push(item.datecreated.format(instance.options.dateFormat));
			data.series[0].push(item.value > 60 ? 30 : item.value);
		});

		if (chart) {
			chart.update(data);
			return;
		}

		setTimeout2('redraw' + instance.id, function() {

			var options = {};
			var opt = instance.options;

			options.fullWidth = true;
			options.chartPadding = { left: 0, right: 20, bottom: 0, top: 20 };
			options.showArea = opt.showArea;
			options.showLine = opt.showLine;
			options.showPoint = opt.showPoint;

			if (opt.smoothCurves)
				options.lineSmooth = Chartist.Interpolation.step();

			opt.low && (options.low = opt.low);
			opt.high && (options.high = opt.high);
			options.axisY = {};
			options.axisY.labelInterpolationFnc = function(v) {
				return opt.formatter.format(v.format(opt.decimals));
			};
			options.axisY.onlyInteger = opt.onlyInteger;
			options.axisY.showGrid = opt.YshowGrid;
			options.axisX = {};
			options.axisX.showGrid = opt.XshowGrid;
			options.axisX.position = 'middle';
			chart = new Chartist.Line(instance.dom, data, options);
		}, 500);
	});

	instance.on('destroy', function() {
		$('#style' + instance.id).remove();
	});

	instance.reconfigure = function() {
		var options = instance.options;
		var color = options.background;
		var area = instance.shade(color, 20);
		var line = instance.shade(color, 20);
		var point = instance.shade(color, -20);
		$('#style' + instance.id).remove();
		$('<style type="text/css" id="style{0}">{1}</style>'.format(instance.id, '.style{3} .ct-series-a .ct-area{fill:#FFFFFF}\n.style{3} .ct-series-a .ct-line{stroke:{1};}\n.style{3} .ct-series-a .ct-point{stroke:#FFFFFF;}.ct-label{color:#FFFFFF;}.style{3} .ct-grid{stroke:#FFFFFF;stroke-opacity:.2}'.format(area, line, point, instance.id))).appendTo('head');
		instance.css('background-color', color);
		chart && chart.detach();
		chart = null;

		// Refresh data
		options.id && instance.send(options.id, 'stats');
	};

	instance.on('resize', function() {
		chart && chart.detach();
		chart = null;
		backup && instance.emit('data', backup);
	});

	instance.make = function() {
		instance.element.addClass('dashboardlinechart style' + instance.id);
		instance.reconfigure();
	};

	instance.on('options', instance.reconfigure);
};

// Dependencies
IMPORT('ONCE https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.min.js');
IMPORT('ONCE https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.min.css');
</script>
